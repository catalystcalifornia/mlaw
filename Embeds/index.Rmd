---
title: ''
author: "Catalyst California"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

library(sf)
library(highcharter)
library(rmapshaper)

options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))
options(scipen=999)

source("W:\\RDA Team\\R\\credentials_source.R")
source("functions.R")

con <- connect_to_db("eci_mlaw")
con2 <- connect_to_db("rda_shared_data")
```

```{r load-data, include=FALSE}

# Read in postgres tables------------------------

# Read in LA city council districts shape
cd <- st_read(con2, query="SELECT * FROM geographies_la.lacitygeohub_lacity_council_districts_2023", geom="geom") %>%
  st_transform(4326) %>%
  ms_simplify()

index <- dbGetQuery(con, "SELECT * FROM pctiles_index")

df <- index %>%
  mutate(pctile=index_pctile) 

# Read in la city zipcode xwalk
zip_xwalk <- st_read(con, query="SELECT * FROM crosswalk_zip_city_2022", geom="geom") %>%
  st_transform(4326) %>%
  ms_simplify()

# join index table with population data to the zip xwalk with our zip geoms
df <- zip_xwalk %>%
  left_join(df, by=c("zipcode"="geoid"))

```

```{r index-map-setup, include=FALSE}

# Map using map function -----

# feed in indicator label for mapping popup and legend and group overlay
indicator <- "Equity Index"
direction <- "higher"

# define colorpalette
colorpalette <- c("#E2D9FF", "#BDAFE9", "#8E7ACA", "#362178", "#211447")
```

```{r index-map-popups}
## Create data popup
# This stores only the data values we'll insert into the custom_popup 
# Note: naming structure in the html tags: [data-][variable-name]
# Note: multiple maps will be on the same report page, so we must add a unique prefix for common data tags so the JS works correctly
# in this case, we'll use these prefixes: equity, d1, d2, d3, and d4 (d for domain)
# Note: only use hyphens (no underscores or other symbols for whitespace)
# We'll use the html tag names again when formatting popup behavior in JS (end of script)
data_popup <- paste0("<div class='equity'> <div class='leaflet-data-equity' data-equity-zipcdode='", df$zipcode,
               "' data-equity-percentile='", df$pctile,
               "' data-equity-population='", format(df$pop, big.mark=","),
               "' data-equity-se-percentile='", round(df$safe_environments_pctile,1),
               "' data-equity-eo-percentile='", round(df$econ_opp_pctile,1),
               "' data-equity-dp-percentile='", round(df$democracy_pctile,1),
               "' data-equity-lv-percentile='", round(df$longevity_pctile,1),
               "'></div></div>")

## Create custom popup
# We are using <div> "class" names (e.g. popup-instruction, division-header) 
# to apply CSS styling (end of script, before JS)
# We are using <span> "class" names (e.g. data-emphasis, division-name) 
# to style with CSS AND insert the data stored in data_popup
# Note: the <span> "class" names are using the SAME naming as in the data_popup (only difference is no "data-" prefix) - this makes things clear and convenient for JS coding (end of script)
custom_popup <- paste0("<div class='leaflet-popup-scrolled'><div class='popup-instruction'>Please click an LA City zip code to read more about that community's equity needs.</div><div class ='zipcode-header'>Zip Code: <span class='equity-zipcode'></span>)</div>
<br>
<b>Equity Index Percentile*: <span class='equity-percentile'></span></b>
<br>
<b>Population:</b> <span class='equity-population'></span>
<br>
<br>
<b>Domain Percentiles*:</b>
<br>
Safe Environments: <span class='equity-se-percentile'></span>
<br>
Economy and Opportunity: <span class='equity-eo-percentile'></span>
<br>
Democracy and Power: <span class='equity-dp-percentile'></span>
<br>
Longevity and Vitality: <span class='equity-lv-percentile'></span>
<br>
<br>",
"<i>*Percentiles range from 0-100. The higher the percentile, the ", direction," the need.</i>",
"</br></br>",
"</div>")

```

# Equity Index
```{r index-map}

index_map(df=df, indicator=indicator, colorpalette=colorpalette, data_popup=data_popup, custom_popup=custom_popup)

```

<style type="text/css">

.zipcode-header {
   margin-bottom: 8px; 
   font-weight: 700; 
   color: #000000;
   font-size: 14px; 
}

.leaflet-popup-scrolled {
  max-height: 580px;
  opacity: 1;
  border-bottom: 0;
  border-top: 0;
}

.info {
  background: white;
  opacity: 1;
  border-radius: 0;
}

.leaflet-left {
  width: 33%;
}

.leaflet-left .leaflet-control {
  font-size: 12px;
  margin-left: 0;
  border-left: 1px solid #ddd;
  border-top: 1px solid #ddd;
  border-bottom: 1px solid #ddd;
}

.leaflet-right .leaflet-control {
  margin-right: 0;
}

.leaflet-top .leaflet-control {
  margin-top: 0;
}

.leaflet-control-container {
  color: #000000;
}

.hidden {
  display: none;
}

.popup-instruction {
  font-style: italic;
  font-weight: 600; 
  font-size: 12px; 
  line-height: 16px;
  color: #000000;
  border-bottom: 1px solid #000000;
  padding-bottom: 16px;
  margin-bottom: 16px;
}

.legend {
  color: #000000;
  border-top: 1px solid #000000;
  padding-top: 1.2em;
}


</style>

