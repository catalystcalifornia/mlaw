---
title: ''
author: "Catalyst California"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

library(sf)
library(highcharter)
library(rmapshaper)

options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))
options(scipen=999)

source("W:\\RDA Team\\R\\credentials_source.R")
source("functions.R")

con <- connect_to_db("eci_mlaw")
con2 <- connect_to_db("rda_shared_data")
```

```{r load-data, include=FALSE}

# Read in postgres tables------------------------

# Read in LA city council districts shape
cd <- st_read(con2, query="SELECT * FROM geographies_la.lacitygeohub_lacity_council_districts_2023", geom="geom") %>%
  st_transform(4326) %>%
  ms_simplify()

dbDisconnect(con2)

index <- dbGetQuery(con, "SELECT * FROM pctiles_index")

df <- index %>%
  mutate(pctile=index_pctile) 

# Read in la city zipcode xwalk
zip_xwalk <- st_read(con, query="SELECT * FROM crosswalk_zip_city_2022", geom="geom") %>%
  st_transform(4326) %>%
  ms_simplify()

dbDisconnect(con)

# join index table with population data to the zip xwalk with our zip geoms
equity_df <- zip_xwalk %>%
  left_join(df, by=c("zipcode"="geoid"))

# add pctile category for equity_data_popup

equity_df <- equity_df %>%
  mutate(equity_pctile_category = case_when(pctile < 20 ~ "Lowest",
                                     pctile >=20 & pctile < 40 ~ "Low",
                                     pctile >=40 & pctile < 60 ~ "Moderate",
                                     pctile >=60 & pctile < 80 ~ "High",
                                     pctile >=80 & pctile <= 100 ~ "Highest",
                                     .default = NA
                                     ),
         safeenv_pctile_category = case_when(safe_environments_pctile < 20 ~ "Lowest",
                                     safe_environments_pctile >=20 & safe_environments_pctile < 40 ~ "Low",
                                     safe_environments_pctile >=40 & safe_environments_pctile < 60 ~ "Moderate",
                                     safe_environments_pctile >=60 & safe_environments_pctile < 80 ~ "High",
                                     safe_environments_pctile >=80 & safe_environments_pctile <= 100 ~ "Highest",
                                     .default = NA
                                     ),
         )

```

```{r index-map-setup, include=FALSE}

# Map using map function -----

# feed in indicator label for mapping popup and legend and group overlay
equity_indicator <- "Equity Index"
direction <- "higher"

# define colorpalette(s)
equity_colorpalette <- c("#E2D9FF", "#BDAFE9", "#8E7ACA", "#362178", "#211447")
```

```{r index-map-popups, include=FALSE}
## Create data popup
# This stores only the data values we'll insert into the custom_popup
# Note: naming structure in the html tags: [data-][variable-name]
# Note: multiple maps will be on the same report page, so we must add a unique prefix for common data tags so the JS works correctly
# in this case, we'll use these prefixes: equity, d1, d2, d3, and d4 (d for domain)
# Note: only use hyphens (no underscores or other symbols for whitespace)
# We'll use the html tag names again when formatting popup behavior in JS (end of script)
equity_data_popup <- paste0("<div class='equity'> <div class='leaflet-data-equity' data-equity-zipcode='", equity_df$zipcode,
               "' data-equity-pctile='", round(equity_df$pctile,1),
               "' data-equity-category='", equity_df$equity_pctile_category,
               "' data-equity-population='", format(equity_df$pop, big.mark=","),
               "' data-safeenv-pctile='", round(equity_df$safe_environments_pctile,1),
               "' data-safeenv-category='", equity_df$safeenv_pctile_category,
               "' data-equity-eo-pctile='", round(equity_df$econ_opp_pctile,1),
               "' data-equity-dp-pctile='", round(equity_df$democracy_pctile,1),
               "' data-equity-lv-pctile='", round(equity_df$longevity_pctile,1),
               "'></div></div>")

## Create custom popup
# We are using <div> "class" names (e.g. popup-instruction, division-header)
# to apply CSS styling (end of script, before JS)
# We are using <span> "class" names (e.g. data-emphasis, division-name)
# to style with CSS AND insert the data stored in data_popup
# Note: the <span> "class" names are using the SAME naming as in the data_popup (only difference is no "data-" prefix) - this makes things clear and convenient for JS coding (end of script)

custom_equity_popup <- paste0("<div class='leaflet-popup-scrolled equity-sidebar'><div class='popup-instruction'>Please click an LA City zip code to read more about that community's equity needs.</div><div class ='location-header'><div class='zipcode-header'><span class='square-icon category-color-error'></span>  <span class='equity-zipcode'></span></div><div class='population-header'>Population:  <span class='equity-population'></span></div></div><br><div class='equity-domains'><b>Equity Index Percentile*: <span class='equity-pctile'></span></b><br><span style='display: block; width: 95%'><div class='pctile-bar'><div class='pctile-equity'></div></div></span><br><br><div class='domains'><b>Domain Percentiles*:</b><br>Safe Environments: <span class='equity-safeenv-pctile'></span><div class='pctile-bar'><div class='pctile-safeenv'></div></div><br>Economy and Opportunity: <span class='equity-eo-pctile'></span><br>Democracy and Power: <span class='equity-dp-pctile'></span><br>Longevity and Vitality: <span class='equity-lv-pctile'></span></div></div><br><br>","<div class='footnote'>*Percentiles range from 0-100. The higher the percentile, the ", direction," the need.</div>","</div>")


```

# Equity Index
```{r index-map}

index_map(df=equity_df, indicator=equity_indicator, colorpalette=equity_colorpalette, data_popup=equity_data_popup, custom_popup=custom_equity_popup)

```

<style type="text/css">

/* minimum required css for leaflet maps with custom sidebars */ 
.info {
    padding: 6px 8px;
    font-size: 12px;
    background: white;
    background: rgba(255,255,255,0.8);
    border-radius: 5px;
}

.legend {
    opacity:  1;
    border-left:1px solid #737373;
    border-right:1px solid #737373;
    border-top:1px solid #737373;
    border-bottom:1px solid #737373;
}

.leaflet-touch .leaflet-control-layers {
  border-left:1px solid #737373;
  border-right:1px solid #737373;
}

.leaflet-popup-scrolled {
  max-height: 350px;
  overflow: auto;
  padding: 2%;
  border: none;
}

.leaflet-left {
  width: 33%;
}

.leaflet-left .leaflet-control {
  background-color: white;
  opacity: 1.0;
}

.leaflet-control-layers .leaflet-control .leaflet-control-layers-expanded {
  background-color: white;
  opacity: 1.0;
}

.hidden {
  display: none;
}

/* css styling for zipcode header with color coded icon */
.location-header {
  display: flex;
  justify-content: space-between;
  align-items:center;
  font-weight: 700; 
  color: #000000;
  font-size: 14px;
}

.zipcode-header {
}

.square-icon {
  height: 14px;
  width: 14px;
  border-radius: 0.25em;
  display: inline-flex;
}

.equity-zipcode {
  font-weight: bold;
  display: inline-flex;
  align-items: center;
}

.population-header {
}

/* css styling that can change depending on the map data and custom styling needs */

.popup-instruction {
  font-style: italic;
  font-weight: 600; 
  line-height: 16px;
  color: #000000;
  border-bottom: 1px solid #000000;
  padding-bottom: 16px;
  margin-bottom: 16px;
}

.footnote {
  font-style: italic;
  padding-top: 16px;
  border-top: 1px solid #000000;
}

/* Styles the bar displaying index pctiles */

.pctile-bar {
  width: 95%;
  display: flex;
  height: 1em;
  background-color: #FBFBFB;
  box-shadow: 0 0 1px black;
  border-radius: 0.25em;
  position: relative;
}

.pctile {
  position: absolute;
  width: 50%;
  height: 100%;
  border-radius: 0.25em;
  
}
.pctile-equity {
  position: absolute;
  height: 100%;
  width: 0%;
  border-radius: 0.25em;
  box-shadow: 0 0 1px black;
  
}

/* MLAW-specific color styling */
.equity-highest-bg-color {
  background-color: #211447; 
}

.equity-high-bg-color {
  background-color: #362178; 
}

.equity-moderate-bg-color {
  background-color: #8E7ACA; 
}

.equity-low-bg-color {
  background-color: #BDAFE9; 
}

.equity-lowest-bg-color {
  background-color: #E2D9FF; 
}

.safeenv-highest-bg-color {
  background-color: #DF4007; 
}

.safeenv-high-bg-color {
  background-color: #F25922; 
}

.safeenv-moderate-bg-color {
  background-color: #FA7B4D; 
}

.safeenv-low-bg-color {
  background-color: #FF9873; 
}

.safeenv-lowest-bg-color {
  background-color: #FFBDA6; 
}

.category-color-error {
  background-color: #737373;
}

</style>


```{js}
// This function is used to format MLAW data in the chloropleth map "popup"/sidebar feature

// Standard set up for using JS with a leaflet map
var mapsPlaceholder = [];
L.Map.addInitHook(function () {
  mapsPlaceholder.push(this);
  mapsPlaceholder.forEach(map => {
      
      // to pre-populate map pop-up (when map loads/before user clicks anywhere)
      map.on('load', (e) => {
        setTimeout(() => {
        document.querySelector('.equity-zipcode').innerHTML = "test"
        document.querySelector('.equity-pctile').innerHTML = "test"
        document.querySelector('.equity-population').innerHTML = "test"
        document.querySelector('.equity-safeenv-pctile').innerHTML = "test"
        document.querySelector('.equity-eo-pctile').innerHTML= "test"
        document.querySelector('.equity-dp-pctile').innerHTML = "test"
        document.querySelector('.equity-lv-pctile').innerHTML = "test"
        }, 500) //assumes the map will load within 500ms - if the initial popup is blank, the map is taking longer than 500ms to load; this can happen if a webpage has many other elements to load
      })
  
      // hide default leaflet popup
      map.on('popupopen', (e) => {
        let popupsEquity = document.querySelectorAll('.leaflet-data-equity');
        // console.log(popups);

        document.querySelectorAll('.equity').forEach(equity => {
        equity.parentElement.parentElement.parentElement.classList.add('hidden')
        })

        // populate custom pop-up when user clicks map
        //console.log('click')
        let popupEquity = popupsEquity[popupsEquity.length-1]
        document.querySelector('.equity-zipcode').innerHTML = popupEquity.getAttribute('data-equity-zipcode')
        document.querySelector('.equity-pctile').innerHTML = popupEquity.getAttribute('data-equity-pctile')
        document.querySelector('.equity-population').innerHTML = popupEquity.getAttribute('data-equity-population')
        document.querySelector('.equity-safeenv-pctile').innerHTML = popupEquity.getAttribute('data-safeenv-pctile')
        document.querySelector('.equity-eo-pctile').innerHTML = popupEquity.getAttribute('data-equity-eo-pctile')
        document.querySelector('.equity-dp-pctile').innerHTML = popupEquity.getAttribute('data-equity-dp-pctile')
        document.querySelector('.equity-lv-pctile').innerHTML = popupEquity.getAttribute('data-equity-lv-pctile')


        
        // adding header styling similar to JENI popup (changes the color of the square block to match pctile category)
        let block = document.querySelector('.square-icon')

        classes = ["equity-lowest-bg-color", "equity-low-bg-color", "equity-moderate-bg-color", "equity-high-bg-color", "equity-highest-bg-color", "category-color-error"]
        classes.forEach(class_ => {
            block.classList.remove(class_)
        })
   
        equityCategory = popupEquity.getAttribute('data-equity-category')
        
        console.log(equityCategory)

        if (equityCategory == "Lowest") {
            block.classList.add('equity-lowest-bg-color');
        } else if (equityCategory == "Low") {
            block.classList.add('equity-low-bg-color');
        } else if (equityCategory == "Moderate") {
            block.classList.add('equity-moderate-bg-color');
        } else if (equityCategory == "High") {
            block.classList.add('equity-high-bg-color');
        } else if (equityCategory == "Highest") {
            block.classList.add('equity-highest-bg-color');
        } else {
            block.classList.add('category-color-error');
        }

        // add pctile-bar styling
        let components = ["equity", "safeenv", "econopp", "democracy", "longevity"]
        components.forEach(component => {
                          
                          
            let pctileBar = document.querySelector('.pctile-' + component)
            let classes = [component + "-lowest-bg-color", component + "-low-bg-color", component + "-moderate-bg-color", component + "-high-bg-color", component + "-highest-bg-color"]
        
            classes.forEach(class_ => {
                pctileBar.classList.remove(class_)
            })
        
            pctileBar.style.width = popupEquity.getAttribute('data-' + component + '-pctile').trim() + "%"
            category = popupEquity.getAttribute('data-' + component + '-category').trim()
        
            if (category == "Lowest") {
                pctileBar.classList.add(component + '-lowest-bg-color');
            } else if (category == "Low") {
                pctileBar.classList.add(component + '-low-bg-color');
            } else if (category == "Moderate") {
                pctileBar.classList.add(component + '-moderate-bg-color');
            } else if (category == "High") {
                pctileBar.classList.add(component + '-high-bg-color');
            } else if (category.trim() == "Highest") {
                pctileBar.classList.add(component + '-highest-bg-color');
            } else {
                pctileBar.classList.add('category-color-error');
            }
          })
        
        
      })
  })
});


```

