---
title: ''
author: "Catalyst California"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment = FALSE, message = FALSE, warning = FALSE, echo = FALSE)

library(sf)
library(highcharter)
library(rmapshaper)

options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))
options(scipen=999)

source("W:\\RDA Team\\R\\credentials_source.R")
source("functions.R")

con <- connect_to_db("eci_mlaw")
con2 <- connect_to_db("rda_shared_data")
```

```{r load-data, include=FALSE}

# Read in postgres tables------------------------

# Read in LA city council districts shape
cd <- st_read(con2, query="SELECT * FROM geographies_la.lacitygeohub_lacity_council_districts_2023", geom="geom") %>%
  st_transform(4326) %>%
  ms_simplify()

index <- dbGetQuery(con, "SELECT * FROM pctiles_index")

df <- index %>%
  mutate(pctile=index_pctile) 

# Read in la city zipcode xwalk
zip_xwalk <- st_read(con, query="SELECT * FROM crosswalk_zip_city_2022", geom="geom") %>%
  st_transform(4326) %>%
  ms_simplify()

# join index table with population data to the zip xwalk with our zip geoms
df <- zip_xwalk %>%
  left_join(df, by=c("zipcode"="geoid"))

```

```{r index-map-setup}

# Map using map function -----

# feed in indicator label for mapping popup and legend and group overlay
indicator <- paste0("Equity Index")
direction <- paste0("higher")

# feed in colorpalette
colorpalette <- c("#E2D9FF", "#BDAFE9", "#8E7ACA", "#362178", "#211447")
nacolor<-"#9B9A9A"

# create popup: 
popup<- paste("<div class='leaflet-popup-scrolled' style='max-width:800px;max-height:200px'> <b>ZIP Code:</b> ", df$zipcode, "</br>",
 "<b>","Equity Index"," Percentile*: ", round(df$pctile,1),"</b></br>",
  "<b>Population:</b> ", format(df$pop, big.mark=","), "</br>",
 "</br>",
 "<b>","Domain Percentiles:","</b></br>",
  "","Safe Environments*: ", round(df$safe_environments_pctile,1),"</br>",
   "","Economy and Opportunity*: ", round(df$econ_opp_pctile,1),"</br>",
   "","Democracy and Power*: ", round(df$democracy_pctile,1),"</br>",
    "","Longevity and Vitality*: ", round(df$longevity_pctile,1),"</br>",
  "</br>",

"<i>*Percentiles range from 0-100. The higher the percentile, the ", direction," the need.</i>","</br>",
"</br></div>")

```

# Equity Index
```{r index-map}

index_map(df=df, indicator=indicator, colorpalette=colorpalette, nacolor=nacolor, popup=popup)

```



